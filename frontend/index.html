<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Alpha ‚Äî Smart Opportunity Matcher</title>
  <meta name="description"
    content="Upload your resume and instantly discover internships, startups, and skill-based opportunities matched to your profile." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="app-wrapper">
    <!-- ==================== HEADER ==================== -->
    <header class="header">
      <div class="header__logo">
        <div class="header__icon">Œ±</div>
        <h1 class="header__title">Project Alpha</h1>
      </div>
      <p class="header__sub">Upload your resume, search for companies, or explore opportunities matched to your skills
      </p>
    </header>

    <!-- ==================== TABS ==================== -->
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="match">üéØ Match Resume</button>
      <button class="tab-btn" data-tab="search">üîç Hybrid Search</button>
      <button class="tab-btn" data-tab="explore">üìã Explore Opportunities</button>
    </div>

    <!-- ==================== TAB 1: MATCH RESUME ==================== -->
    <div class="tab-panel active" id="panel-match">

      <!-- Upload -->
      <div class="upload-zone" id="upload-zone">
        <input type="file" id="file-input" accept=".pdf" />
        <div class="upload-zone__icon">üìÑ</div>
        <div class="upload-zone__text">Drop your resume here or click to browse</div>
        <div class="upload-zone__hint">PDF format only ‚Ä¢ Max 10 MB</div>
        <div class="file-selected" id="file-selected" style="display:none">
          <span>‚úì</span> <span id="file-name"></span>
        </div>
      </div>

      <div style="text-align:center">
        <button class="btn btn-primary" id="analyze-btn" disabled>
          <span id="btn-text">Analyze Resume</span>
        </button>
      </div>

      <!-- Error -->
      <div class="error-msg" id="error-msg"></div>

      <!-- Loader -->
      <div class="loader-wrap" id="loader">
        <div class="spinner"></div>
        <p>Extracting skills and matching opportunities‚Ä¶</p>
      </div>

      <!-- Results -->
      <div class="results" id="results">
        <!-- Overall Advice -->
        <div id="overall-advice-wrap"></div>

        <!-- Extracted Skills -->
        <div>
          <h2 class="section-title">üß† Extracted Skills</h2>
          <div class="skills-grid" id="skills-grid"></div>
        </div>

        <!-- Top Matches -->
        <div>
          <h2 class="section-title">üéØ Top Matches</h2>
          <div id="matches-list"></div>
        </div>

        <!-- Skill Gaps -->
        <div>
          <h2 class="section-title">üìä Skill Gap Analysis</h2>
          <div class="gap-list" id="gap-list"></div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: HYBRID SEARCH ==================== -->
    <div class="tab-panel" id="panel-search">
      <div class="search-box">
        <textarea class="search-textarea" id="search-query"
          placeholder="Describe in detail what kind of companies or roles you are looking for...

e.g. I am a final-year CS student looking for AI/ML internships at startups working on computer vision and deep learning. I know Python, PyTorch, and have basic NLP experience."></textarea>
        <div id="session-hint" class="advice-box" style="display:none; margin-bottom:12px;">
          <div class="advice-box__label">üß† Resume Context Active</div>
          Your uploaded resume is being cross-referenced with search results for personalized ranking.
        </div>
        <p class="search-hint">Tip: The more detail you provide, the better the results. Press
          <strong>Ctrl+Enter</strong> to search.</p>
        <button class="btn btn-search" id="search-btn" onclick="performHybridSearch()">
          <span id="search-btn-text">Discover Companies</span>
          <div class="spinner-inline" id="search-loader"></div>
        </button>
        <div class="error-msg" id="search-error"></div>
      </div>

      <div id="search-results">
        <!-- Dynamic company cards injected here -->
      </div>
    </div>

    <!-- ==================== TAB 3: EXPLORE ==================== -->
    <div class="tab-panel" id="panel-explore">
      <div class="search-bar">
        <input class="search-input" id="search-input" placeholder="Search by title, company, or skill‚Ä¶" />
        <select class="filter-select" id="filter-type">
          <option value="">All Types</option>
          <option value="internship">Internship</option>
          <option value="full-time">Full-time</option>
        </select>
      </div>
      <div class="opp-count" id="opp-count"></div>
      <div id="opp-list"></div>
    </div>
  </div>

  <script>
    // ==============================================================
    // CONFIG
    // ==============================================================
    const API = 'http://localhost:8000';

    // ==============================================================
    // DOM REFS
    // ==============================================================
    const $ = (sel) => document.querySelector(sel);
    const fileInput = $('#file-input');
    const uploadZone = $('#upload-zone');
    const fileSelected = $('#file-selected');
    const fileName = $('#file-name');
    const analyzeBtn = $('#analyze-btn');
    const btnText = $('#btn-text');
    const loaderEl = $('#loader');
    const resultsEl = $('#results');
    const errorEl = $('#error-msg');
    const skillsGrid = $('#skills-grid');
    const matchesList = $('#matches-list');
    const gapList = $('#gap-list');
    const searchInput = $('#search-input');
    const filterType = $('#filter-type');
    const oppList = $('#opp-list');
    const oppCount = $('#opp-count');

    let selectedFile = null;
    let allOpportunities = [];
    let currentSessionId = '';  // Populated after resume upload for cross-reference

    // ==============================================================
    // TABS
    // ==============================================================
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        $(`#panel-${btn.dataset.tab}`).classList.add('active');

        if (btn.dataset.tab === 'explore' && allOpportunities.length === 0) {
          loadOpportunities();
        }
      });
    });

    // ==============================================================
    // FILE UPLOAD
    // ==============================================================
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
      if (file.type !== 'application/pdf') {
        showError('Please upload a PDF file.');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showError('File too large. Max 10 MB.');
        return;
      }
      selectedFile = file;
      fileName.textContent = file.name;
      fileSelected.style.display = 'flex';
      analyzeBtn.disabled = false;
      hideError();
    }

    // ==============================================================
    // ANALYZE
    // ==============================================================
    analyzeBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      hideError();
      resultsEl.classList.remove('active');
      loaderEl.classList.add('active');
      analyzeBtn.disabled = true;
      btnText.textContent = 'Analyzing‚Ä¶';

      try {
        const form = new FormData();
        form.append('file', selectedFile);

        const res = await fetch(`${API}/upload_resume`, { method: 'POST', body: form });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `Server error (${res.status})`);
        }
        const data = await res.json();
        if (data.session_id) {
          currentSessionId = data.session_id;
          // Show a toast/indicator that the session is linked
          const hint = $('#session-hint');
          if (hint) { hint.style.display = 'block'; }
        }
        renderResults(data);
      } catch (err) {
        showError(err.message);
      } finally {
        loaderEl.classList.remove('active');
        analyzeBtn.disabled = false;
        btnText.textContent = 'Analyze Resume';
      }
    });

    // ==============================================================
    // RENDER RESULTS (Resume)
    // ==============================================================
    function renderResults(data) {
      // Overall Advice
      const overallWrap = $('#overall-advice-wrap');
      if (data.overall_advice) {
        overallWrap.innerHTML = `
          <div class="advice-box advice-box--overall">
            <div class="advice-box__label">üí° Your Personalized Summary</div>
            <div class="advice-content">${renderMarkdown(data.overall_advice)}</div>
          </div>`;
      } else {
        overallWrap.innerHTML = '';
      }

      // Skills
      skillsGrid.innerHTML = data.extracted_skills
        .map(s => `<span class="skill-chip">${escHtml(s)}</span>`)
        .join('');

      // Matches
      matchesList.innerHTML = data.matches.map((m, i) => {
        const pct = Math.round(m.skill_overlap_ratio * 100);
        const scoreClass = m.match_score >= 0.65 ? 'score-high'
          : m.match_score >= 0.45 ? 'score-medium'
            : 'score-low';
        const linkedinHtml = m.linkedin_url
          ? `<a class="linkedin-link" href="${escAttr(m.linkedin_url)}" target="_blank" rel="noopener">üîó View on LinkedIn</a>`
          : '';
        return `
          <div class="match-card">
            <div class="match-card__header">
              <div class="match-card__rank">${i + 1}</div>
              <div class="match-card__info">
                <div class="match-card__title">${escHtml(m.title)}</div>
                <div class="match-card__org">${escHtml(m.organisation)}</div>
              </div>
              <div class="score-badge ${scoreClass}">${(m.match_score * 100).toFixed(1)}%</div>
            </div>

            <div class="progress-bar">
              <div class="progress-bar__fill" style="width:${pct}%"></div>
            </div>

            ${m.advice ? `
              <div class="advice-box">
                <div class="advice-box__label">ü§ñ AI Insight</div>
                ${escHtml(m.advice)}
              </div>` : ''}

            <div class="score-breakdown">
              <div class="score-breakdown__item">
                <span class="score-breakdown__label">Semantic Match</span>
                <span class="score-breakdown__value">${(m.semantic_score * 100).toFixed(1)}%</span>
              </div>
              <div class="score-breakdown__item">
                <span class="score-breakdown__label">Skill Overlap</span>
                <span class="score-breakdown__value">${pct}%</span>
              </div>
              <div class="score-breakdown__item">
                <span class="score-breakdown__label">Skills Matched</span>
                <span class="score-breakdown__value">${m.matched_skills.length} / ${m.matched_skills.length + m.missing_skills.length}</span>
              </div>
            </div>

            ${m.matched_skills.length ? `
              <div class="skills-label">‚úÖ Matched Skills</div>
              <div class="match-skills">
                ${m.matched_skills.map(s => `<span class="match-skills__chip match-skills__chip--matched">${escHtml(s)}</span>`).join('')}
              </div>` : ''}

            ${m.missing_skills.length ? `
              <div class="skills-label">‚ùå Missing Skills</div>
              <div class="match-skills">
                ${m.missing_skills.map(s => `<span class="match-skills__chip match-skills__chip--missing">${escHtml(s)}</span>`).join('')}
              </div>` : ''}

            ${linkedinHtml}
          </div>`;
      }).join('');

      // Gaps with advice
      if (data.skill_gaps.length === 0) {
        gapList.innerHTML = '<div class="empty-state">‚ú® No skill gaps ‚Äî you perfectly match these roles!</div>';
      } else {
        gapList.innerHTML = data.skill_gaps.map(g => `
          <div class="gap-item-wrap">
            <div class="gap-item-row">
              <div class="gap-item__dot gap-item__dot--${g.importance}"></div>
              <div class="gap-item__skill">${escHtml(g.skill)}</div>
              <div class="gap-item__badge gap-item__badge--${g.importance}">${g.importance}</div>
            </div>
            ${g.advice ? `<div class="gap-item__advice">üí° ${escHtml(g.advice)}</div>` : ''}
          </div>`).join('');
      }

      resultsEl.classList.add('active');
    }

    // ==============================================================
    // HYBRID SEARCH (Tab 2)
    // ==============================================================
    async function performHybridSearch() {
      const query = $('#search-query').value.trim();
      const resultsContainer = $('#search-results');
      const errorBox = $('#search-error');
      const loader = $('#search-loader');
      const btnTxt = $('#search-btn-text');
      const btn = $('#search-btn');

      errorBox.style.display = 'none';
      resultsContainer.innerHTML = '';

      if (!query) {
        errorBox.textContent = 'Please enter a search query.';
        errorBox.style.display = 'block';
        errorBox.classList.add('active');
        return;
      }

      btn.disabled = true;
      btnTxt.style.display = 'none';
      loader.style.display = 'inline-block';

      try {
        const response = await fetch(`${API}/hybrid_search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query, session_id: currentSessionId, top_k: 10 })
        });

        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        const data = await response.json();

        if (data.length === 0) {
          resultsContainer.innerHTML = '<div class="empty-state">No confident matches found. Try providing more details.</div>';
        } else {
          renderCompanyResults(data);
        }
      } catch (err) {
        errorBox.textContent = `Search failed: ${err.message}. Ensure the backend is running.`;
        errorBox.style.display = 'block';
        errorBox.classList.add('active');
      } finally {
        btn.disabled = false;
        btnTxt.style.display = 'inline';
        loader.style.display = 'none';
      }
    }

    function renderCompanyResults(companies) {
      const container = $('#search-results');
      container.innerHTML = companies.map((c, i) => {
        const scorePct = Math.min(100, Math.round(c.match_score * 100));
        const rolesHtml = c.matched_roles
          .map(r => `<span class="role-pill">${escHtml(r)}</span>`)
          .join('');

        return `
          <div class="company-card" style="animation: fadeUp 0.4s ease ${i * 0.08}s both;">
            <div class="company-card__header">
              <h2 class="company-card__name">${escHtml(c.organisation)}</h2>
              <div class="company-card__score">${scorePct}% Match</div>
            </div>
            <p class="company-card__desc">${escHtml(c.description)}</p>
            ${c.matched_roles.length ? `
              <div class="company-card__roles-title">Matched Roles Available</div>
              <div class="role-pills">${rolesHtml}</div>
            ` : ''}
            <div class="company-card__location">üìç ${escHtml(c.location)}${c.geo_match ? ' <span class="meta-tag meta-tag--type" style="margin-left:8px;">üéØ GEO MATCH</span>' : ''}</div>
            ${c.resume_skill_overlap && c.resume_skill_overlap.length ? `
              <div class="skills-label" style="margin-top:12px">üß† Resume Skill Overlap</div>
              <div class="match-skills">
                ${c.resume_skill_overlap.map(s => '<span class="match-skills__chip match-skills__chip--matched">' + escHtml(s) + '</span>').join('')}
              </div>
            ` : ''}
          </div>`;
      }).join('');
    }

    // Ctrl+Enter to search
    $('#search-query').addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') performHybridSearch();
    });

    // ==============================================================
    // OPPORTUNITIES (Tab 3)
    // ==============================================================
    async function loadOpportunities() {
      oppList.innerHTML = '<div class="loader-wrap active"><div class="spinner"></div><p>Loading opportunities‚Ä¶</p></div>';
      try {
        const res = await fetch(`${API}/opportunities`);
        allOpportunities = await res.json();
        renderOpportunities(allOpportunities);
      } catch (err) {
        oppList.innerHTML = `<div class="empty-state">Failed to load opportunities.</div>`;
      }
    }

    function renderOpportunities(list) {
      oppCount.textContent = `${list.length} opportunities found`;
      if (list.length === 0) {
        oppList.innerHTML = '<div class="empty-state">No opportunities match your filters.</div>';
        return;
      }
      oppList.innerHTML = list.map(o => {
        const linkedinHtml = o.linkedin_url
          ? `<a class="linkedin-link" href="${escAttr(o.linkedin_url)}" target="_blank" rel="noopener">üîó View on LinkedIn</a>`
          : '';
        return `
        <div class="opp-card">
          <div class="opp-card__top">
            <div>
              <div class="opp-card__title">${escHtml(o.title)}</div>
              <div class="opp-card__org">${escHtml(o.organisation)}</div>
            </div>
          </div>
          <div class="opp-card__meta">
            <span class="meta-tag meta-tag--type">${escHtml(o.type)}</span>
            <span class="meta-tag meta-tag--location">üìç ${escHtml(o.location)}</span>
          </div>
          ${o.required_skills && o.required_skills.length ? `
            <div class="skills-label" style="margin-top:12px">Required Skills</div>
            <div class="match-skills">
              ${o.required_skills.slice(0, 8).map(s => `<span class="match-skills__chip match-skills__chip--matched">${escHtml(s)}</span>`).join('')}
              ${o.required_skills.length > 8 ? `<span class="match-skills__chip match-skills__chip--matched">+${o.required_skills.length - 8} more</span>` : ''}
            </div>` : ''}
          ${linkedinHtml}
        </div>`;
      }).join('');
    }

    searchInput.addEventListener('input', filterOpps);
    filterType.addEventListener('change', filterOpps);

    function filterOpps() {
      const q = searchInput.value.toLowerCase().trim();
      const type = filterType.value;
      const filtered = allOpportunities.filter(o => {
        const matchType = !type || o.type === type;
        const matchQ = !q ||
          o.title.toLowerCase().includes(q) ||
          o.organisation.toLowerCase().includes(q) ||
          (o.required_skills || []).some(s => s.toLowerCase().includes(q));
        return matchType && matchQ;
      });
      renderOpportunities(filtered);
    }

    // ==============================================================
    // UTILS
    // ==============================================================
    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
    function escAttr(s) {
      return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function renderMarkdown(text) {
      if (!text) return '';
      // Escape HTML first for safety
      let html = escHtml(text);
      // Headers: #### ‚Üí h4, ### ‚Üí h3, ## ‚Üí h2
      html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
      html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
      // Bold: **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic: *text*
      html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
      // Checkbox list items: - [ ] or - [x]
      html = html.replace(/^\s*[-*]\s*\[\s*\]\s+(.+)$/gm, '<li class="checklist-item"><span class="checkbox">‚òê</span> $1</li>');
      html = html.replace(/^\s*[-*]\s*\[x\]\s+(.+)$/gim, '<li class="checklist-item checked"><span class="checkbox">‚òë</span> $1</li>');
      // Bullet list items: - item or * item
      html = html.replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>');
      // Numbered list items: 1. item
      html = html.replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>');
      // Wrap consecutive <li> in <ul>
      html = html.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g, '<ul>$1</ul>');
      // Inline code: `text`
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Paragraphs: double newline
      html = html.replace(/\n\n+/g, '</p><p>');
      // Single newlines within paragraphs
      html = html.replace(/\n/g, '<br>');
      // Wrap in paragraph tags
      html = '<p>' + html + '</p>';
      // Clean up empty paragraphs
      html = html.replace(/<p>\s*<\/p>/g, '');
      // Clean up paragraphs around block elements
      html = html.replace(/<p>\s*(<h[2-4]>)/g, '$1');
      html = html.replace(/(<\/h[2-4]>)\s*<\/p>/g, '$1');
      html = html.replace(/<p>\s*(<ul>)/g, '$1');
      html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
      return html;
    }
    function showError(msg) { errorEl.textContent = msg; errorEl.classList.add('active'); }
    function hideError() { errorEl.classList.remove('active'); }
  </script>
</body>

</html>